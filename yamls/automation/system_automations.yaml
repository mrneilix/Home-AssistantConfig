- id: system_startup
  alias: 'System Startup'
  hide_entity: true
  initial_state: true
  trigger:
    platform: homeassistant
    event: start
  action:
    - service: logbook.log
      data_template:
        name: Starting
        message: Hass is Starting
    - service: scene.turn_on
      entity_id: scene.startup_reset_variables
    - delay: 00:00:05
    - service: shell_command.restart_pi_sys_stat
    - service: logbook.log
      data_template:
        name: Shell Command
        message: Restart Pi Zero System Stats
    - delay: 00:00:50
    - service: script.startup_scripts

# - id: system_internet_down
  # alias: 'System Internet Down'
  # trigger: 
    # - platform: template
      # value_template: '{{ states.sensor.speedtest_download.state| float < 5 }}'
  # condition:
    # - condition: state
      # entity_id: input_boolean.restart_complete
      # state: 'on'
  # action:      
    # - service: script.restart_homeassistant
    
- id: system_restart_monitor
  alias: 'System Restart Monitor'
  trigger: 
    platform: time
    at: '12:00:00'
  condition:
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
  action:
    - service: shell_command.restart_monitor
    - service: logbook.log
      data_template:
        name: Shell Command
        message: Restart Monitor

- id: system_scheduled_reboot_pi
  alias: 'System Scheduled Reboot Pi'
  trigger:
    platform: time
    at: '03:40:00'
  condition:
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
    - condition: time
      weekday:
      - mon
  action:
    - service: script.reboot_pi_zero
    - service_template: >
          {% if is_state('input_boolean.config_updated', 'on') %}
            script.system_backup
          {% else %}
            script.do_nothing
          {% endif %}
    - delay: 00:20:00
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.config_updated
    - service: script.system_reboot

# - id: system_scheduled_restart_ha
  # alias: 'System Scheduled Restart HA'
  # trigger:
    # platform: time
    # at: '04:00:00'
  # condition:
    # - condition: state
      # entity_id: input_boolean.config_updated
      # state: 'off'
    # - condition: state
      # entity_id: input_boolean.restart_complete
      # state: 'on'
    # - condition: time
      # weekday:
      # - wed
      # - fri
  # action:
    # - service: script.restart_homeassistant

- id: system_update_input_boolean_for_config_backup
  alias: 'System Update Input Boolean for Config Backup'
  trigger:
    - platform: event
      event_type: folder_watcher
      event_data:
        event_type: created
    - platform: event
      event_type: folder_watcher
      event_data:
        event_type: modified
    - platform: event
      event_type: folder_watcher
      event_data:
        event_type: deleted
    - platform: event
      event_type: folder_watcher
      event_data:
        event_type: moved
  condition:
    - condition: state
      entity_id: input_boolean.config_updated
      state: 'off'
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.config_updated

- id: system_backup_config
  alias: 'System Backup Config'
  trigger:
    platform: time
    at: '03:40:00'
  condition:
    - condition: state
      entity_id: input_boolean.config_updated
      state: 'on'
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
  action:
    - service: script.system_backup
    - condition: time
      weekday:
      - sun
      - tue
      - wed
      - thu
      - fri
      - sat
    - delay: 00:20:00
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.config_updated
    - service: script.restart_homeassistant

- id: system_reboot_confirmed
  alias: 'System Reboot Confirmed'
  trigger:
    platform: event
    event_type: html5_notification.clicked
    event_data:
      action: confirm_system_reboot
  condition:
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
  action:
    - service: script.system_reboot