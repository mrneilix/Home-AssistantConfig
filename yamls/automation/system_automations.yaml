- id: system_startup
  alias: 'System Startup'
  hide_entity: true
  initial_state: true
  trigger:
    platform: homeassistant
    event: start
  action:
    - service: logger.set_level
      data:
        homeassistant.components: fatal
    - service: logbook.log
      data_template:
        name: Restarting
        message: Hass is Restarting
    - service: scene.turn_on
      entity_id: scene.startup_reset_variables
    - service: shell_command.restart_monitor
    - delay: 00:00:05
    - service: shell_command.restart_pi_sys_stat
    - delay: 00:00:05
    - service: shell_command.restart_tv_status_monitor
    - delay: 00:00:50
    - service: script.startup_scripts
    - delay: 00:00:20
    - service: logger.set_level
      data:
        homeassistant.components: critical
    - service: script.presence_tasker_phone_location
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.restart_complete

- id: system_internet_down
  alias: 'System Internet Down'
  trigger: 
    - platform: template
      value_template: '{{ states.sensor.speedtest_download.state| float < 5 }}'
  condition:
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
  action:      
    - service: homeassistant.restart
    
- id: system_monitor_pi_zero_down
  alias: 'System Monitor Pi Zero Down'
  trigger: 
    - platform: state
      entity_id: sensor.neil_mqtt_pixel
      to: 'unknown'
      for:
        minutes: 5
    - platform: state
      entity_id: sensor.neil_mqtt_charge_2
      to: 'unknown'
      for:
        minutes: 5
    - platform: state
      entity_id: sensor.butters_mqtt_tile
      to: 'unknown'
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
  action:
    - service: shell_command.restart_monitor

- id: system_scheduled_reboot_pi
  alias: 'System Scheduled Reboot Pi'
  trigger:
    platform: time
    at: '04:00:00'
  condition:
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
    - condition: time
      weekday:
      - mon
  action:
    - service: shell_command.reboot_pi_zero
    - delay: 00:10:00
    - service: hassio.host_reboot

- id: system_scheduled_restart_ha
  alias: 'System Scheduled Restart HA'
  trigger:
    platform: time
    at: '04:30:00'
  condition:
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
    - condition: time
      weekday:
      - mon
      - wed
      - fri
  action:
    - service: homeassistant.restart

- id: system_restart_ha_if_MQTT_did_not_update
  alias: 'System Restart HA if MQTT Did Not Update'
  trigger:
    platform: state
    entity_id: input_boolean.restart_complete
    to: 'on'
  condition:
    - condition: template
      value_template: "{{ ((as_timestamp(now()) - as_timestamp(states.sensor.last_boot.state)) < 600) and  is_state('sensor.pi_zero_uptime', 'unknown') }}"
  action:
    - service: homeassistant.restart

- id: system_update_input_boolean_for_config_backup
  alias: 'System Update Input Boolean for Config Backup'
  trigger:
    - platform: state
      entity_id: sensor.automation
    - platform: state
      entity_id: sensor.customize
    - platform: state
      entity_id: sensor.devices
    - platform: state
      entity_id: sensor.home_assistant_yamls
    - platform: state
      entity_id: sensor.scripts
    - platform: state
      entity_id: sensor.sensors
    - platform: state
      entity_id: sensor.config
  condition:
    - condition: state
      entity_id: input_boolean.config_updated
      state: 'off'
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.config_updated

- id: system_backup_config
  alias: 'System Backup Config'
  trigger:
    platform: time
    at: '03:30:00'
  condition:
    - condition: state
      entity_id: input_boolean.config_updated
      state: 'on'
    - condition: state
      entity_id: input_boolean.restart_complete
      state: 'on'
  action:
    - service: shell_command.git_backup
    - delay: 00:00:60
    - service: hassio.snapshot_full
      data_template:
        name: Automated Backup {{ now().strftime('%Y-%m-%d') }}
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.config_updated
    - delay: 00:05:00
    - condition: time
      weekday:
      - sun
      - tue
      - thu
      - sat
    - service: homeassistant.restart