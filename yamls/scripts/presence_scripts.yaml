presence_arrive:
  alias: Presence Arrive
  sequence:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.presence_running
    - service: lock.unlock
      entity_id: lock.schlage_deadbolt_47
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.away
    - service: switch.turn_on
      entity_id: switch.space_heater_35
    - service: switch.turn_off
      entity_id: switch.yi_power
    - service_template: >
          {% if is_state('binary_sensor.dark_out', 'on') %}
            script.presence_arrive_dark_out
          {% else %}
            script.do_nothing
          {% endif %}
    - service: script.thermostat_home_set_temp
    - service: joaoapps_join.fire_send_tasker
      data:
        command: arrive
    - service: script.presence_tasker_phone_location
    - service: script.startup_input_booleans

presence_someone_not_neil_home:
  alias: Presence Someone Not Neil Home
  sequence:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.presence_running
    - service: lock.unlock
      entity_id: lock.schlage_deadbolt_47
    - service_template: >
          {% if is_state('binary_sensor.dark_out', 'on') %}
            script.presence_arrive_dark_out
          {% else %}
            script.do_nothing
          {% endif %}
    - service: script.thermostat_home_set_temp

presence_arrive_dark_out:
  alias: Presence Arrive Dark Out
  sequence:
    - condition: time
      before: '03:58:00'
      after: '04:10:00'
    - service: scene.turn_on
      entity_id: scene.kitchen_lights_on

presence_leave:
  alias: Presence Leave
  sequence:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.presence_running
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.parents_lock_code
    - service: scene.turn_on
      entity_id: scene.lights_off
    - service: scene.turn_on
      entity_id: scene.leave_switches_off
    - service: lock.lock
      entity_id: lock.schlage_deadbolt_47
    - service: joaoapps_join.fire_send_tasker
      data:
        command: leave
    - service_template: >
          {% if is_state('input_boolean.tv_power', 'on') or is_state('binary_sensor.tv_mqtt_monitor', 'on') %}
            script.tv_off
          {% else %}
            script.do_nothing
          {% endif %}
    - service: script.presence_tasker_phone_location
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.away
    - service_template: >
          {% if is_state('input_boolean.butters_home', 'off') %}
            script.thermostat_temp_everyone_away
          {% else %}
            script.thermostat_set_temp_only_butters_home
          {% endif %}
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.presence_running

presence_parents_home:
  alias: Presence Parents Home
  sequence:
    - service: script.presence_someone_not_neil_home
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.kitchen_display
        volume_level: 0.6
    - service: tts.google_say
      entity_id: media_player.kitchen_display
      data_template:
        message: "Hello, Mom or Dad."
    - condition: state
      entity_id: input_boolean.notifications_on
      state: 'on'
    - service: notify.html5
      data_template:
        message: "Parents unlocked the door at {{ as_timestamp(now()) | timestamp_custom('%I:%M:%S %p', true) }}"
        title: "Door Unlocked"
        data:
          tag: 'door-unlocked'
          icon: '/local/pictures/mom-dad.jpg'
          badge: '/local/pictures/lock-badge.png'

presence_gina_home:
  alias: Presence Gina Home
  sequence:
    - service: script.presence_someone_not_neil_home
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.kitchen_display
        volume_level: 0.6
    - service: tts.google_say
      entity_id: media_player.kitchen_display
      data_template:
        message: "Hello, Gina."
    - condition: state
      entity_id: input_boolean.notifications_on
      state: 'on'
    - service: notify.html5
      data_template:
        message: "Gina unlocked the door at {{ as_timestamp(now()) | timestamp_custom('%I:%M:%S %p', true) }}"
        title: "Door Unlocked"
        data:
          tag: 'door-unlocked'
          icon: '/local/pictures/gina.jpg'
          badge: '/local/pictures/lock-badge.png'

presence_tasker_phone_location:
  alias: Presence Tasker Phone Location
  sequence:
    - service: joaoapps_join.pixel_send_tasker
      data:
        command: "get_phone_location"