lock_code_entered_not_family:
  alias: Lock Code Entered
  sequence:
    - service: tts.google_say
      entity_id: media_player.kitchen_display
      data_template:
        message: "Hello, {{states('sensor.last_lock_code_name')}}."
    - condition: state
      entity_id: input_boolean.presence_automations
      state: 'on'
    - service_template: >
          {% if is_state('sensor.last_lock_code_name', 'Guest') %}
            script.lock_guest_code_entered
          {% else %}
            script.lock_temp_code_entered
          {% endif %}

lock_guest_code_entered:
  alias: Lock Guest Code Entered
  sequence:
    - service: script.presence_someone_arrived
    - condition: state
      entity_id: input_boolean.notifications_on
      state: 'on'
    - service: script.notify_guest_code_entered

lock_temp_code_entered:
  alias: Lock Temp Code Entered
  sequence:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.presence_running
    - service: lock.unlock
      entity_id: lock.schlage_deadbolt_91
    - service_template: >
          {% if is_state('binary_sensor.dark_out', 'on') %}
            script.presence_arrive_dark_out
          {% else %}
            script.do_nothing
          {% endif %}
    - delay: 00:01:00
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.presence_running
    - service_template: >
          {% if is_state("input_select.temp_code_single_use", "Yes") %}
            script.lock_clear_temp_code
          {% else %}
            script.do_nothing
          {% endif %}
    - service: script.notify_temp_code_entered

lock_clear_temp_code:
  alias: Lock Clear Temp Code
  sequence:
    - delay: 00:00:10
    - service: scene.turn_on
      entity_id: scene.clear_temp_code
    - service: input_select.select_option
      data:
        entity_id: input_select.temp_code_single_use
        option: "Yes"

lock_set_temp_lock_code:
  alias: Lock Set Temp Lock Code
  sequence:
    - service: mqtt.publish
      data_template:
        topic: "Vera/Events/SetTempLockCode"
        payload_template: "{{ states.input_text.lock_code_temp.state }}"
    - delay: 00:00:10
    - service: input_text.set_value
      data:
        entity_id: input_text.lock_code_temp
        value: 'Code'
    - delay: 00:00:60
    - condition: state
      entity_id: input_boolean.temp_lock_code_set
      state: 'off'
    - service: notify.html5
      data_template:
        message: "Temporary Lock Code Did Not Update"
        title: "Temporary Lock Code Not On"
        data:
          tag: 'lock_not_updated'
          renotify: 0
          icon: '/local/lock.jpg'
          badge: '/local/lock-badge.png'

lock_clear_parents_lock_code:
  alias: Lock Clear Parents Lock Code
  sequence:
    - delay: 00:00:10
    - service: scene.turn_on
      entity_id: scene.clear_parents_code

lock_set_parents_lock_code:
  alias: Lock Set Parents Lock Code
  sequence:
    - delay: 00:00:10
    - service: scene.turn_on
      entity_id: scene.add_parents_code