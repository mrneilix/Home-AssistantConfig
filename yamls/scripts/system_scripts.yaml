startup_scripts:
  alias: Startup Scripts
  sequence:
    - service: lock.lock
      entity_id: lock.schlage_deadbolt_91
    - service: script.startup_input_booleans
    - delay: 00:00:02
    - service: script.couch_light_update_input_text
    - delay: 00:00:02
    - service: script.startup_presence
    - delay: 00:00:30
    - service: scene.turn_on
      entity_id: scene.last_lock_code_used
    - delay: 00:00:30
    - service_template: >
          {% if (((as_timestamp(now()) - as_timestamp(states.sensor.last_boot.state)) )| int) < 360 %}
            script.system_restart_if_just_rebooted
          {% else %}
            script.system_turn_on_automations_on_restart
          {% endif %}

startup_presence:
  alias: Startup Presence
  sequence:
    - service_template: >
          {% if is_state('device_tracker.neil', 'home') %}
            script.startup_neil_home
          {%-elif is_state('binary_sensor.anyone_home', 'on') %}
            script.startup_neil_not_home
          {% else %}
            script.presence_no_humans_home
          {% endif %}

startup_input_booleans:
  alias: Startup Input Booleans
  sequence:
    - service_template: > 
          {%- if now().hour >= 8 and now().hour < 23 and is_state('device_tracker.neil', 'home')%}
            input_boolean.turn_on
          {% else %}
            input_boolean.turn_off
          {% endif %}
      data:
        entity_id: input_boolean.notifications_on
    - service_template: > 
          {%- if now().hour >= 8 and now().hour < 23 and is_state('device_tracker.neil', 'home') %}
            input_boolean.turn_on
          {% else %}
            input_boolean.turn_off
          {% endif %}
      data:
        entity_id: input_boolean.weather_notifications
    - service_template: > 
          {% if is_state('device_tracker.butters', 'home') %}
            input_boolean.turn_on
          {% else %}
            input_boolean.turn_off
          {% endif %}
      data:
        entity_id: input_boolean.butters_home

startup_neil_home:
  alias: Startup Neil Home
  sequence:
    - service: switch.turn_off
      entity_id: switch.yi_power
    - service_template: >
          {% if is_state('binary_sensor.dark_out', 'on') and now().hour >= 8 and now().hour < 23 %}
            script.presence_arrive_dark_out
          {% else %}
            script.do_nothing
          {% endif %}
    - service: script.thermostat_home_set_temp

startup_neil_not_home:
  alias: Startup Neil Not Home
  sequence:
    - service: switch.turn_off
      entity_id: switch.yi_power
    - service_template: >
          {% if is_state('binary_sensor.anyone_home', 'on') %}
            script.thermostat_home_set_temp
          {%-elif is_state('input_boolean.butters_home', 'off') %}
            script.thermostat_temp_everyone_away
          {% else %}
            script.thermostat_set_temp_only_butters_home
          {% endif %}

restart_homeassistant:
  alias: Restart Home Assistant
  sequence:
    - service: switch.turn_on
      entity_id: switch.yi_power
    - service: homeassistant.restart

system_restart_if_just_rebooted:
  alias: System Restart If Just Rebooted
  sequence:
    - service: shell_command.phlex_login
    - service: logbook.log
      data_template:
        name: Shell Command
        message: Desktop Log Into Phlex and Grafana
    - delay: 00:01:00
    - service: script.restart_homeassistant

system_turn_on_automations_on_restart:
  alias: System Turn On Automations On Restart
  sequence:
    - service: automation.turn_on
      entity_id: group.all_automations
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.restart_complete

reboot_pi_zero:
  alias: Reboot Pi Zero
  sequence:
    - service: shell_command.reboot_pi_zero
    - service: logbook.log
      data_template:
        name: Shell Command
        message: Reboot Pi Zero

confirm_system_reboot:
  alias: Confirm System Reboot
  sequence:
    - service: notify.html5
      data:
        message: "Are you sure you want to reboot?"
        data: {
          renotify: 0,
          tag: 'reboot',
          icon: '/local/pictures/restart-ha.png',
          badge: '/local/pictures/restart-ha.png',
          actions: [
            {
              action: "confirm_system_reboot",
              title: "Yes"
            },
            {
              action: "dismiss",
              title: "Dismiss"
            },
      ]
    }

system_reboot:
  alias: Reboot System
  sequence:
    - service: switch.turn_on
      entity_id: switch.yi_power
    - delay: 00:00:02
    - service: hassio.host_reboot

system_git_backup:
  alias: Startup Load Couch
  sequence:
    - service: logbook.log
      data_template:
        name: Shell Command
        message: Git Backup
    - service: shell_command.git_backup

system_desktop_display_off:
  alias: System Desktop Display Off
  sequence:
    - service: logbook.log
      data_template:
        name: Shell Command
        message: Desktop Display Off
    - service: shell_command.desktop_screen_off
do_nothing:
  alias: Do Nothing
  sequence:
    - delay: 00:00:01

