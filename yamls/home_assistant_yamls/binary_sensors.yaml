#PRESENCE
  - platform: template
    sensors:
      anyone_home:
        friendly_name: Anyone Home
        value_template: >-
          {%- if is_state("device_tracker.neil", "home")
          or is_state("device_tracker.parents", "home")
          or is_state("device_tracker.gina", "home")
              -%}
          True
          {%- else -%}
          False
          {%- endif %}
        entity_id:
          - device_tracker.neil
          - device_tracker.parents
          - device_tracker.gina

      lock_code_entered:
        friendly_name: Lock Code Entered
        value_template: >-
          {% if (as_timestamp(now()) - as_timestamp(states.sensor.last_lock_code_name.last_changed) < 300 ) and (as_timestamp(now()) - as_timestamp(states.binary_sensor.front_door_sensor_73.last_changed) < 300 ) and (states('sensor.uptime') | int > 10) %}
            True
          {% else %}
            False
          {% endif %}
        entity_id:
          - sensor.last_lock_code_name
          - binary_sensor.front_door_sensor_73
          - sensor.time

      lock_code_entered_neil:
        friendly_name: Neil Lock Code Entered
        entity_picture_template: /local/pictures/Me.jpg
        device_class: presence
        value_template: >-
          {% if is_state("sensor.last_lock_code_name", "Neil") and is_state("binary_sensor.lock_code_entered", "on") %}
            True
          {% else %}
            False
          {% endif %}
        entity_id:
          - sensor.last_lock_code_name
          - sensor.time
          - binary_sensor.lock_code_entered
          - binary_sensor.front_door_sensor_73

      lock_code_entered_parents:
        friendly_name: Parent's Lock Code Entered
        entity_picture_template: /local/pictures/mom-dad.jpg
        device_class: presence
        value_template: >-
          {% if is_state("sensor.last_lock_code_name", "Parents") and is_state("binary_sensor.lock_code_entered", "on") %}
            True
          {% else %}
            False
          {% endif %}
        entity_id:
          - sensor.last_lock_code_name
          - sensor.time
          - binary_sensor.lock_code_entered
          - binary_sensor.front_door_sensor_73

      lock_code_entered_gina:
        friendly_name: Gina's Lock Code Entered
        entity_picture_template: /local/pictures/gina.jpg
        device_class: presence
        value_template: >-
          {% if is_state("sensor.last_lock_code_name", "Gina") and is_state("binary_sensor.lock_code_entered", "on") %}
            True
          {% else %}
            False
          {% endif %}
        entity_id:
          - sensor.last_lock_code_name
          - sensor.time
          - binary_sensor.lock_code_entered
          - binary_sensor.front_door_sensor_73

      anyone_home_but_neil:
        friendly_name: Anyone Home But Neil
        value_template: >-
          {%- if is_state("device_tracker.neil", "home") %}
            False
          {%-elif is_state("device_tracker.gina", "home") %}
            True
          {%-elif is_state("device_tracker.parents", "home") %}
            True
          {%- else -%}
            False
          {%- endif %}
        entity_id:
          - device_tracker.neil
          - device_tracker.gina
          - device_tracker.parents

# Dark Outside
      dark_out:
        friendly_name: Dark Outside
        value_template: >-
          {% if states('sensor.illuminance') | int < 5500 %}
            True
          {%- else -%}
            False
          {%- endif %}
        entity_id:
          - sensor.illuminance
      show_calendar_events:
        value_template: '{{ (((  as_timestamp(strptime(states.calendar.events.attributes.start_time, "%d.%m.%Y")) - as_timestamp(now()) ) / 86400 ) | round(0) < 14 ) }}'
      show_calendar_family_birthdays:
        value_template: '{{ (((  as_timestamp(strptime(states.calendar.family_birthdays.attributes.start_time, "%d.%m.%Y")) - as_timestamp(now()) ) / 86400 ) | round(0) < 30 ) }}'
      show_calendar_friend_birthdays:
        value_template: '{{ (((  as_timestamp(strptime(states.calendar.friend_birthdays.attributes.start_time, "%d.%m.%Y")) - as_timestamp(now()) ) / 86400 ) | round(0) < 30 ) }}'
      show_calendar_facebook:
        value_template: '{{ (((  as_timestamp(strptime(states.calendar.facebook_events.attributes.start_time, "%d.%m.%Y")) - as_timestamp(now()) ) / 86400 ) | round(0) < 30 ) }}'
      show_calendar_deliveries:
        value_template: >-
          {% if states.calendar.deliveries.attributes.message == '' or states.calendar.deliveries.state == 'off' %}
            False
          {% elif ((( as_timestamp(strptime(states.calendar.deliveries.attributes.start_time, "%d.%m.%Y")) - as_timestamp(now()) ) / 86400 ) | round(0) < 30 ) %}
            True
          {% else %}
            False
          {% endif %}

# MQTT Status
      mqtt_status:
        device_class: connectivity
        friendly_name: MQTT Status
        value_template: >-
          {%if (as_timestamp(now()) - as_timestamp(states.sensor.monitor_status.last_updated) < 300 ) and not is_state("sensor.monitor_status", "offline") %}
            True
          {%-elif (as_timestamp(now()) - as_timestamp(states.sensor.pi_zero_uptime.last_updated) < 300 ) and not is_state("sensor.pi_zero_uptime", "unknown") %}
            True
          {%-elif (as_timestamp(now()) - as_timestamp(states.device_tracker.neil_pixel_tasker.last_updated) < 6000 ) %}
            True
          {%- else -%}
            False
          {%- endif %}

# Thermostat Set Home
      thermostat_set_home:
        friendly_name: Thermostat Set Home
        value_template: >-
          {%- if states.script.thermostat_leave_set_temp.attributes.last_triggered == none %}
            True
          {%-elif states.script.thermostat_home_set_temp.attributes.last_triggered == none %}
            False
          {%-elif ( as_timestamp(states.script.thermostat_leave_set_temp.attributes.last_triggered) | int ) < ( as_timestamp(states.script.thermostat_home_set_temp.attributes.last_triggered) | int ) %}
            True
          {%- else -%}
            False
          {%- endif %}
        entity_id:
          - script.thermostat_leave_set_temp
          - script.thermostat_home_set_temp

      dyson_bedroom_on:
        friendly_name: Dyson Bedroom Fan On
        value_template: >-
          {%- if states.fan.bedroom.attributes.auto_mode == true %}
            True
          {%- else -%}
            False
          {%- endif %}
        entity_id:
          - fan.bedroom

      dyson_bedroom_oscillation_on:
        friendly_name: Dyson Bedroom Oscillate On
        value_template: >-
          {%- if states.fan.bedroom.attributes.oscillating == true %}
            True
          {%- else -%}
            False
          {%- endif %}
        entity_id:
          - fan.bedroom
# MagicMirror Display Rotating
      magic_mirror_display_rotation_off:
        value_template: >-
          {%- if states.script.system_magic_mirror_rotate_display_on.attributes.last_triggered == none %}
            True
          {%-elif states.script.system_magic_mirror_rotate_display_off.attributes.last_triggered == none %}
            False
          {%-elif ( as_timestamp(states.script.system_magic_mirror_rotate_display_on.attributes.last_triggered) | int ) < ( as_timestamp(states.script.system_magic_mirror_rotate_display_off.attributes.last_triggered) | int ) %}
            True
          {%- else -%}
            False
          {%- endif %}
        entity_id:
          - script.system_magic_mirror_rotate_display_off
          - script.system_magic_mirror_rotate_display_on
  - platform: ping
    host: 192.168.1.126
    count: 5
    name: vera_up
